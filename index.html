<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>gpt.xlsx viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    header { display:flex; gap:12px; align-items:baseline; flex-wrap:wrap; }
    .meta { color:#555; font-size: 14px; }
    .controls { margin: 10px 0; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select, button, input { padding: 6px 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
    thead th { background: #f6f6f6; position: sticky; top: 0; z-index: 1; }
    #status { margin-left:auto; }
    .error { color:#b00020; white-space: pre-wrap; margin-top: 8px; }
    .wrap { overflow:auto; max-height: 80vh; border: 1px solid #eee; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0">gpt.xlsx</h1>
    <div class="meta">Source: <a id="srcLink" target="_blank" rel="noreferrer">download</a></div>
    <div class="meta" id="lastLoaded">Last loaded: —</div>
  </header>

  <div class="controls">
    <label>Sheet:
      <select id="sheetSelect"></select>
    </label>

    <button id="reloadBtn">Reload</button>

    <label class="meta">Auto-refresh (sec):
      <input id="refreshSec" type="number" min="5" step="5" value="60" style="width:90px" />
    </label>

    <div class="meta" id="status">Idle</div>
  </div>

  <div id="error" class="error"></div>
  <div class="wrap" id="tableWrap"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // CORS-safe raw file URL
    const XLSX_URL = "https://raw.githubusercontent.com/ahentzschel/gpt/main/gpt.xlsx";

    const srcLink = document.getElementById("srcLink");
    const sheetSelect = document.getElementById("sheetSelect");
    const reloadBtn = document.getElementById("reloadBtn");
    const refreshSecInput = document.getElementById("refreshSec");
    const statusEl = document.getElementById("status");
    const lastLoadedEl = document.getElementById("lastLoaded");
    const errorEl = document.getElementById("error");
    const tableWrap = document.getElementById("tableWrap");

    srcLink.href = XLSX_URL;

    let wb = null;
    let timer = null;

    function setStatus(s){ statusEl.textContent = s; }
    function clearError(){ errorEl.textContent = ""; }
    function showError(e){ errorEl.textContent = String(e && e.stack ? e.stack : e); }

    function normalizeRows(rows) {
      const maxCols = rows.reduce((m, r) => Math.max(m, (r || []).length), 0);
      return rows.map(r => {
        const row = r || [];
        if (row.length < maxCols) row.length = maxCols;
        return row.map(v => v === undefined ? "" : v);
      });
    }

    function renderSheet(name) {
      if (!wb) return;
      const ws = wb.Sheets[name];
      if (!ws) return;

      const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, blankrows: true });
      const rows = normalizeRows(rawRows);

      if (!rows.length) {
        tableWrap.innerHTML = "<p style='padding:8px'>Sheet is empty.</p>";
        return;
      }

      // Build column headers A, B, C...
      const colCount = rows[0].length;
      const colName = (n) => {
        let s = "";
        while (n > 0) { const m = (n - 1) % 26; s = String.fromCharCode(65 + m) + s; n = Math.floor((n - 1) / 26); }
        return s;
      };

      const table = document.createElement("table");

      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      const corner = document.createElement("th");
      corner.textContent = "#";
      trh.appendChild(corner);
      for (let c = 1; c <= colCount; c++) {
        const th = document.createElement("th");
        th.textContent = colName(c);
        trh.appendChild(th);
      }
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        const rowHead = document.createElement("th");
        rowHead.textContent = String(idx + 1);
        tr.appendChild(rowHead);

        r.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = (cell === null ? "" : String(cell));
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      tableWrap.innerHTML = "";
      tableWrap.appendChild(table);
    }

    async function loadWorkbook() {
      clearError();
      setStatus("Loading…");
      try {
        const url = XLSX_URL + "?t=" + Date.now(); // cache-bust
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("Fetch failed: " + res.status + " " + res.statusText);

        const ab = await res.arrayBuffer();
        wb = XLSX.read(new Uint8Array(ab), { type: "array" });

        sheetSelect.innerHTML = "";
        wb.SheetNames.forEach(n => {
          const opt = document.createElement("option");
          opt.value = n;
          opt.textContent = n;
          sheetSelect.appendChild(opt);
        });

        const first = wb.SheetNames[0];
        sheetSelect.value = first;
        renderSheet(first);

        lastLoadedEl.textContent = "Last loaded: " + new Date().toLocaleString();
        setStatus("Loaded");
      } catch (e) {
        setStatus("Error");
        showError(e);
      }
    }

    function startAutoRefresh() {
      if (timer) clearInterval(timer);
      const sec = Number(refreshSecInput.value || 60);
      if (!Number.isFinite(sec) || sec < 5) return;
      timer = setInterval(loadWorkbook, sec * 1000);
    }

    sheetSelect.addEventListener("change", () => renderSheet(sheetSelect.value));
    reloadBtn.addEventListener("click", loadWorkbook);
    refreshSecInput.addEventListener("change", startAutoRefresh);

    window.addEventListener("load", () => { loadWorkbook(); startAutoRefresh(); });
  </script>
</body>
</html>
